<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>project-axiom!</title>
        <script src="libs/phaser/build/phaser.min.js"></script>
        <script src="libs/jquery/jquery-2.2.0.min.js"></script>
        <script src="libs/jquery/jquery-ui.js"></script>
        <script src="libs/bootstrap/js/bootstrap.min.js"></script>
        <script src="libs/knockout/knockout-3.4.0.js"></script>
        <script src="libs/parallel/js/parallel.js"></script>

        <script src="libs/ace/js/ace.js"></script>
        <script src="libs/ace/js/theme-twilight.js" type="text/javascript" charset="utf-8"></script>

        <script src="libs/skulpt/js/skulpt.min.js" type="text/javascript"></script>
        <script src="libs/skulpt/js/skulpt-stdlib.js" type="text/javascript"></script>

        <link rel="stylesheet" type="text/css" href="libs/ace/css/site.css">

        <script src="src/EditMode.js"></script>
        <script src="src/Droid.js"></script>

        <link rel="stylesheet" type="text/css" href="libs/sidebar/css/sidebar.css">
        <link rel="stylesheet" type="text/css" href="libs/jquery/css/jquery-ui.css">
    </head>

    <body>

    <script type="text/javascript">
        var editor;
        var droid;

        function ToggleEditor()
        {
            $( "#editor" ).toggle( "slide", {
                direction : 'right'});

            return false;
        }

        function InitGUI()
        {

        }

        window.onload = function() {
            editor = ace.edit("editor");
            var map;
            var layer;
            var cursors;
            var game = new Phaser.Game(800, 600, Phaser.CANVAS, 'phaser-game', { preload: preload, create: create, update: update, render: render });

            function preload() {
                InitGUI();

                game.load.image('grass', 'assets/tiles/grass.png');
                game.load.image('tiles', 'assets/tiles/tmw_desert_spacing.png');

                game.load.image('droid', 'assets/sprites/Droid.png');
                game.load.image('droid_selected', 'assets/sprites/Droid2.png');
            }

            function fillMap()
            {
                for (var x = 0; x < map.width; x++)
                {
                    for(var y = 0; y < map.height; y++)
                    {
                        map.putTile(0, x, y);
                    }
                }
            }

            function create() {
                game.stage.backgroundColor = '#2d2d2d';
                map = game.add.tilemap();


                map.addTilesetImage('grass');
                layer = map.create('ground', 40, 30, 32, 32);
                layer.resizeWorld();
                fillMap();

                game.physics.startSystem(Phaser.Physics.ARCADE);

                cursors = game.input.keyboard.createCursorKeys();
                game.input.mouse.capture = true;

                game.input.onTap.add(WorldClick);

                droid = new Droid(game, 100, 100);
            }

            function WorldClick(pointer, doubleTap){

            }

            function update() {
                updateCamera();
                droid.Update();
            }

            function updateCamera()
            {
                if (cursors.left.isDown)
                {
                    game.camera.x -= 10;
                }
                else if (cursors.right.isDown)
                {
                    game.camera.x += 10;
                }

                 if (cursors.up.isDown)
                {
                    game.camera.y -= 10;
                }
                else if (cursors.down.isDown)
                {
                    game.camera.y += 10;
                }
            }

            function render() {

            }

            editor.setTheme("ace/theme/twilight");
            editor.getSession().setMode("ace/mode/python");
        };

        function runCode()
        {
            var p = new Parallel(editor.getValue()
            )

            p = new Parallel(editor.getValue(), {
              env: {
                thing: droid
              }
            });

            p.require(moveDroid);

            p.spawn(execute).then(function() { alert("Done");});

            return false;
        }

        function execute(code)
        {
           eval(code);
        }

        function moveDroid(x, y)
        {
            global.env.thing.sprite.x = x;
        }

    </script>

    <div id="phaser-game"></div>

    <input id="ToggleEditorCheckBox" type="checkbox" onchange="return ToggleEditor();" >Code Mode</input>

    <div id="editor" class="sidebar sidebar-right" style="display:none"></div>

    <button onclick="return runCode();">Run</button>
    <pre id="output" ></pre>

    </body>
</html>